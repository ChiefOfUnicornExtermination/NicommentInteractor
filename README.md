# ニコニコ生放送コメント連動API起動スクリプト
ニコニコ生放送でのコメントを取得し、API（特に家庭でのスマートデバイスのコントロール）を呼び出すスクリプトです。
このフォルダにある[commentreactor.js](./commentreactor.js)が実際に使うスクリプトです。

現在のところ簡易版ということで
1. 対象の配信をPCのブラウザで見る
2. →開発者ウィンドウ（F12）を開く
3. →コンソールに[スクリプト](./commentreactor.js)を全部張り付けてEnter

という使い方のものとなっています。
ファイルはjsファイルですが、実行の際はメモ帳などで開きスクリプトをコピー（もしくはここGitHubのページ上でコピー）後、デバイス部分を上書きしてコンソールに張り付けるだけです。
さすがにこれでは一般利用は厳しいため、サーバー動作版を開発中です。それまでのつなぎ及び各配信者が正式版公開・運用時にどういったことができるのかの思索用のつもりで確認してください。
仕様上はニコニコ動画など生放送でなくても使えると思いますが、意味はないと思います。

スクリプトは @tor4kichi様（ https://qiita.com/tor4kichi ）の「ニコ生配信をアプリで再生」を~~丸パクリ~~参考にさせていただきました。
この場を借りてお礼申し上げます。 
https://qiita.com/tor4kichi/items/5c438aa11fea5422103b 
https://qiita.com/tor4kichi/items/4df5b11ec564bb8f8d16 

スクリプト上部の動作に関する部分がtor4kichi様~~の丸パクリ~~作成のものを参照とした基本動作、そこに受け付けるコメントと各デバイスの設定を下部に追記したものになります。
使用の際はスクリプト上のコメントに従ってご家庭でお使いのスマートデバイスなどの設定に書き換えてください。

動作をテストするためのHTML、張り付けるためのスクリプトを生成するスクリプト…などがあったほうが便利でしょうが（実際私も超簡素なHTMLで試して作りました）、
__そんなところに労力を割くくらいならサーバー動作版をさっさと作るのに力をいれたほうがマシ__…ということで多分作りません。各自で空のHTMLに入れて試しましょう。

## 利用者が修正する場所と構成
```javascript
var devices = new Array(
  {
    deviceid: 1, // デバイス番号。利用目的は忘れました。いらんかも
    devicename: "スマート電球１号", // コマンド受付完了メッセージに表示する対象デバイス名
    isAvailable: true, // デバイス利用可否。設定しておいたデバイスを最終的に使うかどうかをここで切り替えます
    devicenamecandidates: ["電球１", "でんとう"], // 対象デバイスの名称。あいまいなコメントに対応します
    baseUrl: "https://device-control.devicecompany.com/api/v2/", // 対象APIのURL。処理によりURLを書き換えなければならないAPIに対応していないためその場合はその処理を追加してください
    method: "POST", // HTTPメソッド。これも固定を想定していますので変更ある場合は修正してください
    headers: {"header1": "header1value", "header2": "header2value"}, // HTTPヘッダの値。APIに必要なものを設定します。動的な値を指定しなければならない場合はその処理を追加する必要があります。
    requestBody: '{"requestItem": {"method": "X", "value": "1"}}', // HTTPリクエストボディの値です。今のところ{{0}}をコマンド名、{{1}}を値に書き換える処理を入れています。
    commands: { // デバイスに対する処理の指定です。
      command1:{
        keywords:["キーワード１", "キーワード２",..], // 受け付けるキーワードです。実際の処理は別で行い、あくまで「この中にある値が書かれていたら処理を行う指標」です。
        finishMessage: "コマンド１を{{0}}りましたよ？", // 処理完了後のメッセージテンプレートです。処理の戻り値messageで{{0}}を置き換えます
        commandcode: "", // APIに投げるBODYの{{0}}部分の置き換え値
        querystring: [""], // APIのURLにクエリ付与しなければならないこともあるかと思ってたのですが使わなかったので実装してないですね。固定値追加するようにしかなっていないので意味ないですね。必要になったら実装してください。
        handlingfunc: function(device, message){return {value: "", message: "処理ッ！"}} // デバイス情報とユーザーのコメントを受け取り、値とメッセージを並べたオブジェクトを返すメソッドを書いてください。
      },
      command2:{
      }
      ...
    }
  }
);
```

## 残す問題点、その他不具合
+ 「スクリプトを開発者ウィンドウに張り付けて実行」がどうしようもなくダサい。これはもうこのバージョンはそういうお試し版ということで破棄したい。とにかくプログラムになじみがない人がそのまま使えるようにまるでなっていない。わかる人間もしくはわかる人間にサポート受けないと使えない。
+ その性質上、コードが全部セキュアな部分も含めて一つに入っちゃってる。今だと私の個人キーと私有家具のキーがまんまコード内にある。使うのもアレだけど更新したり発展させたりしようがない。少なくとも正式版ではコードと個人固有値を分ける。
+ 「色を指定」がちゃんとしてない。赤や緑は直接指定でその色になるが、それ以外の「青っぽくする」などはコマンドを繰り返せば繰り返すほど変な色になっていく感じ。何か計算ミスがある。
+ 「濃く」「薄く」がもう絶望的に違う。単純にすごくまぶしくなるだけ。根本的に間違いがあるうえに「今の値」がグチャるせいでそれ以降の色が変になる。
+ 大文字小文字、ひらがなカタカナ半角カナなどは統一処理で拾えた。めんどくさいから更新しないけど簡単にできるはず。なんなら捌く処理は別にして拾う側の処理は正規表現ですべき。
+ 「水色にする」が一度も動作しなかった気がする。多分これもなんか間違ってる。
+ セキュリティをゴミ箱に投げ捨てたGOVEEのAPIなのでURLもヘッダも固定値でいってるけど、それ以外のメーカーで使われる際にはその辺認証してヘッダに入れる必要があるのが普通のはず。むつかしくはないと思うが対応が必要。
+ 来たコマンド、マッチしたものはすべて対応してしまっているが、大手配信者を想定した場合はありえない仕様。ランダムでピックアップする、コマンド実行者を覚えておいて一定時間に一回しか許可しなくする、サポーター登録者やフォロワー、匿名解除している者のみを対象にする、同じコマンドがある程度までの数来たら実行するなど、フィルタが必要。できればデバイスごとに別々でしたい。
+ その他、「なんだかたまに反応しない」が散見された。原因不明のまま。不具合なのか投稿/API受付の問題なのか…正式版を作るうえでは対処が必要。将来的に「バハムート飛んだら花火を上げる」とかやる可能性があることを考えると動きませんでしたでは許されない。
